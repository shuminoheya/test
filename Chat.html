<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‹QRæ¥ç¶š WebRTC ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin: 4px 0;
    }
    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: inherit;
    }
    button {
      padding: 6px 12px;
      margin: 4px 4px 4px 0;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: white;
      font-size: 14px;
    }
    button:disabled {
      background: #aaa;
      cursor: default;
    }
    #status {
      font-size: 14px;
      margin-top: 4px;
    }
    #status span {
      font-weight: bold;
    }
    #qrcode-host, #qrcode-guest {
      margin-top: 8px;
    }
    #log {
      width: 100%;
      height: 160px;
      box-sizing: border-box;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #111;
      color: #0f0;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #chat-area {
      height: 160px;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 6px;
      overflow-y: auto;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .chat-self {
      color: #1976d2;
    }
    .chat-peer {
      color: #2e7d32;
    }
    #html5-qrcode {
      width: 260px;
      max-width: 100%;
      margin-top: 8px;
    }
  </style>

  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‹QRæ¥ç¶š WebRTC ãƒãƒ£ãƒƒãƒˆ</h1>

  <div class="section">
    <label>
      <b>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ2äººã§åŒã˜ã‚‚ã®ã‚’ä½¿ã†ï¼‰:</b>
      <input type="text" id="password" placeholder="ä¾‹: secret123">
    </label>

    <label>
      <input type="radio" name="role" value="host" checked> ãƒ›ã‚¹ãƒˆ
    </label>
    <label>
      <input type="radio" name="role" value="guest"> ã‚²ã‚¹ãƒˆ
    </label>

    <div style="margin-top:8px;">
      <button id="btn-host-start">ãƒ›ã‚¹ãƒˆã¨ã—ã¦éƒ¨å±‹ã‚’ä½œã‚‹</button>
      <button id="btn-guest-start">ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ ã™ã‚‹</button>
      <button id="btn-start-scan" disabled>QRèª­ã¿å–ã‚Šé–‹å§‹</button>
      <button id="btn-stop-scan" disabled>QRèª­ã¿å–ã‚Šåœæ­¢</button>
    </div>

    <div id="status">
      çŠ¶æ…‹: <span id="status-text">æœªæ¥ç¶š</span>
    </div>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin:0 0 4px;">ãƒ›ã‚¹ãƒˆå´ã®QR</h2>
    <div id="qrcode-host"></div>
    <small>ãƒ›ã‚¹ãƒˆãŒç”Ÿæˆã™ã‚‹ QRã€‚ã‚²ã‚¹ãƒˆã«ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚</small>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin:0 0 4px;">ã‚²ã‚¹ãƒˆå´ã®QR</h2>
    <div id="qrcode-guest"></div>
    <small>ã‚²ã‚¹ãƒˆãŒç”Ÿæˆã™ã‚‹ QRã€‚ãƒ›ã‚¹ãƒˆã«ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚</small>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin:0 0 4px;">QRèª­ã¿å–ã‚Š</h2>
    <div id="html5-qrcode"></div>
    <small>ã€ŒQRèª­ã¿å–ã‚Šé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã€ç›¸æ‰‹ã® QR ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚</small>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin:0 0 4px;">ãƒãƒ£ãƒƒãƒˆ</h2>
    <div id="chat-area"></div>
    <div style="margin-top:6px;">
      <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" disabled>
      <button id="chat-send" disabled>é€ä¿¡</button>
    </div>
  </div>

  <div class="section">
    <h2 style="font-size:16px;margin:0 0 4px;">ãƒ­ã‚°</h2>
    <div id="log"></div>
  </div>

  <script>
    // --- UI è¦ç´ ã®å–å¾— ---
    const passwordInput = document.getElementById('password');
    const roleRadios = document.getElementsByName('role');
    const btnHostStart = document.getElementById('btn-host-start');
    const btnGuestStart = document.getElementById('btn-guest-start');
    const btnStartScan = document.getElementById('btn-start-scan');
    const btnStopScan = document.getElementById('btn-stop-scan');
    const statusText = document.getElementById('status-text');
    const logEl = document.getElementById('log');
    const chatArea = document.getElementById('chat-area');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    const qrcodeHostEl = document.getElementById('qrcode-host');
    const qrcodeGuestEl = document.getElementById('qrcode-guest');

    let html5QrCode = null;
    let currentRole = 'host';
    let pc = null;
    let dataChannel = null;
    let localOfferCreated = false;
    let connectionEstablished = false;

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text) {
      statusText.textContent = text;
    }

    function getPassword() {
      return passwordInput.value.trim();
    }

    function checkedRole() {
      for (const r of roleRadios) {
        if (r.checked) return r.value;
      }
      return 'host';
    }

    function clearQRCodes() {
      qrcodeHostEl.innerHTML = '';
      qrcodeGuestEl.innerHTML = '';
    }

    function enableChat(enable) {
      chatInput.disabled = !enable;
      chatSend.disabled = !enable;
    }

    function appendChatMessage(text, self) {
      const div = document.createElement('div');
      div.className = self ? 'chat-self' : 'chat-peer';
      div.textContent = (self ? 'è‡ªåˆ†: ' : 'ç›¸æ‰‹: ') + text;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // --- WebRTC ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
    function createPeerConnection() {
      const config = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }
        ]
      };
      pc = new RTCPeerConnection(config);

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          // trickle ICE ã¯ä½¿ã‚ãšã€å€™è£œã¯ SDP ã«å«ã‚ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
        }
      };

      pc.onconnectionstatechange = () => {
        log(`connectionState: ${pc.connectionState}`);
        if (pc.connectionState === 'connected') {
          setStatus('æ¥ç¶šå®Œäº†');
          connectionEstablished = true;
          enableChat(true);
        } else if (pc.connectionState === 'disconnected' ||
                   pc.connectionState === 'failed' ||
                   pc.connectionState === 'closed') {
          connectionEstablished = false;
          enableChat(false);
        }
      };

      pc.ondatachannel = (event) => {
        log('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«å—ä¿¡');
        setupDataChannel(event.channel);
      };

      log('RTCPeerConnection ä½œæˆ');
    }

    function setupDataChannel(ch) {
      dataChannel = ch;
      dataChannel.onopen = () => {
        log('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ« open');
        if (pc.connectionState === 'connected') {
          enableChat(true);
        }
      };
      dataChannel.onclose = () => {
        log('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ« close');
        enableChat(false);
      };
      dataChannel.onerror = (e) => {
        log('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ« error: ' + e);
      };
      dataChannel.onmessage = (event) => {
        appendChatMessage(event.data, false);
      };
    }

    // QR ã«åŸ‹ã‚è¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
    function createQrPayload(type, sdp, password) {
      const obj = {
        v: 1,
        role: currentRole,
        kind: type, // "offer" or "answer"
        pass: password,
        sdp: sdp
      };
      return JSON.stringify(obj);
    }

    // QR èª­ã¿å–ã‚Šå¾Œã®å‡¦ç†
    async function handleQrPayload(text) {
      log('QR èª­ã¿å–ã‚Š: ' + text.slice(0, 40) + '...');
      let obj;
      try {
        obj = JSON.parse(text);
      } catch (e) {
        alert('QRã®å½¢å¼ãŒä¸æ­£ã§ã™');
        log('JSON parse error');
        return;
      }
      const password = getPassword();
      if (!password) {
        alert('å…ˆã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (obj.pass !== password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
        log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´');
        return;
      }
      if (!pc) {
        createPeerConnection();
      }

      if (obj.kind === 'offer') {
        // ã‚²ã‚¹ãƒˆãŒãƒ›ã‚¹ãƒˆã® offer ã‚’èª­ã¿å–ã‚‹
        log('offer ã‚’ã‚»ãƒƒãƒˆ');
        await pc.setRemoteDescription(new RTCSessionDescription({
          type: 'offer',
          sdp: obj.sdp
        }));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        const payload = createQrPayload('answer', answer.sdp, password);
        qrcodeGuestEl.innerHTML = '';
        new QRCode(qrcodeGuestEl, {
          text: payload,
          width: 200,
          height: 200,
        });
        log('answer QR ã‚’ç”Ÿæˆï¼ˆã‚²ã‚¹ãƒˆâ†’ãƒ›ã‚¹ãƒˆï¼‰');
        setStatus('ã‚²ã‚¹ãƒˆ: answer ã‚’ç”Ÿæˆã€‚ãƒ›ã‚¹ãƒˆã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚');

      } else if (obj.kind === 'answer') {
        // ãƒ›ã‚¹ãƒˆãŒã‚²ã‚¹ãƒˆã® answer ã‚’èª­ã¿å–ã‚‹
        log('answer ã‚’ã‚»ãƒƒãƒˆ');
        await pc.setRemoteDescription(new RTCSessionDescription({
          type: 'answer',
          sdp: obj.sdp
        }));
        setStatus('ãƒ›ã‚¹ãƒˆ: answer ã‚’å—ä¿¡ã€‚æ¥ç¶šå¾…æ©Ÿä¸­...');
      } else {
        alert('ä¸æ˜ãª kind ã§ã™');
      }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
    btnHostStart.addEventListener('click', async () => {
      currentRole = 'host';
      const password = getPassword();
      if (!password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      clearQRCodes();
      enableChat(false);
      connectionEstablished = false;

      createPeerConnection();
      const channel = pc.createDataChannel('chat');
      setupDataChannel(channel);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const payload = createQrPayload('offer', offer.sdp, password);
      new QRCode(qrcodeHostEl, {
        text: payload,
        width: 200,
        height: 200,
      });
      localOfferCreated = true;
      setStatus('ãƒ›ã‚¹ãƒˆ: offer QR ã‚’ç”Ÿæˆã€‚ã‚²ã‚¹ãƒˆã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚');
      log('offer QR ã‚’ç”Ÿæˆï¼ˆãƒ›ã‚¹ãƒˆâ†’ã‚²ã‚¹ãƒˆï¼‰');

      btnStartScan.disabled = false;
    });

    btnGuestStart.addEventListener('click', () => {
      currentRole = 'guest';
      const password = getPassword();
      if (!password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      clearQRCodes();
      enableChat(false);
      connectionEstablished = false;
      createPeerConnection();

      setStatus('ã‚²ã‚¹ãƒˆ: ãƒ›ã‚¹ãƒˆã® QR ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚');
      btnStartScan.disabled = false;
    });

    // QR èª­ã¿å–ã‚Šé–‹å§‹
    btnStartScan.addEventListener('click', () => {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("html5-qrcode");
      }

      Html5Qrcode.getCameras().then(cameras => {
        if (!cameras || cameras.length === 0) {
          alert('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const cameraId = cameras[0].id;
        html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: 220
          },
          (decodedText, decodedResult) => {
            // èª­ã¿å–ã£ãŸã‚‰ã™ãæ­¢ã‚ã‚‹
            html5QrCode.stop().then(() => {
              btnStartScan.disabled = false;
              btnStopScan.disabled = true;
            });
            handleQrPayload(decodedText);
          },
          (errorMessage) => {
            // èª­ã¿å–ã‚Šå¤±æ•—ã¯ãƒ­ã‚°ã«ã ã‘å‡ºã™
            // log('QR scan error: ' + errorMessage);
          }
        ).then(() => {
          btnStartScan.disabled = true;
          btnStopScan.disabled = false;
          log('QRèª­ã¿å–ã‚Šé–‹å§‹');
        }).catch(err => {
          alert('QRèª­ã¿å–ã‚Šé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
        });
      });
    });

    // QR èª­ã¿å–ã‚Šåœæ­¢
    btnStopScan.addEventListener('click', () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          btnStartScan.disabled = false;
          btnStopScan.disabled = true;
          log('QRèª­ã¿å–ã‚Šåœæ­¢');
        });
      }
    });

    // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
    chatSend.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!dataChannel || dataChannel.readyState !== 'open') {
        alert('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ«ãŒé–‹ã„ã¦ã„ã¾ã›ã‚“');
        return;
      }
      dataChannel.send(text);
      appendChatMessage(text, true);
      chatInput.value = '';
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        chatSend.click();
      }
    });

    // role åˆ‡ã‚Šæ›¿ãˆ
    for (const r of roleRadios) {
      r.addEventListener('change', () => {
        currentRole = checkedRole();
      });
    }
  </script>
</body>
</html>
