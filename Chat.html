<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‹QRï¼‹ãƒ†ã‚­ã‚¹ãƒˆæ¥ç¶š WebRTC ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    textarea {
      width: 100%;
      height: 120px;
      box-sizing: border-box;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      padding: 6px 12px;
      margin: 4px 4px 4px 0;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: white;
      font-size: 14px;
    }
    button:disabled {
      background: #aaa;
      cursor: default;
    }
    #chat-area {
      height: 160px;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 6px;
      overflow-y: auto;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .chat-self { color: #1976d2; }
    .chat-peer { color: #2e7d32; }
    #log {
      width: 100%;
      height: 160px;
      background: #111;
      color: #0f0;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
  </style>

  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h1>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‹QRï¼‹ãƒ†ã‚­ã‚¹ãƒˆæ¥ç¶š WebRTC ãƒãƒ£ãƒƒãƒˆ</h1>

<div class="section">
  <label><b>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ2äººã§åŒã˜ã‚‚ã®ã‚’ä½¿ã†ï¼‰:</b></label>
  <input type="text" id="password" placeholder="ä¾‹: secret123">

  <label><input type="radio" name="role" value="host" checked> ãƒ›ã‚¹ãƒˆ</label>
  <label><input type="radio" name="role" value="guest"> ã‚²ã‚¹ãƒˆ</label>

  <div style="margin-top:8px;">
    <button id="btn-host-start">ãƒ›ã‚¹ãƒˆã¨ã—ã¦éƒ¨å±‹ã‚’ä½œã‚‹</button>
    <button id="btn-guest-start">ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ ã™ã‚‹</button>
    <button id="btn-start-scan" disabled>QRèª­ã¿å–ã‚Šé–‹å§‹</button>
    <button id="btn-stop-scan" disabled>QRèª­ã¿å–ã‚Šåœæ­¢</button>
  </div>

  <div id="status">çŠ¶æ…‹: <span id="status-text">æœªæ¥ç¶š</span></div>
</div>

<div class="section">
  <h2>ãƒ›ã‚¹ãƒˆå´ QR</h2>
  <div id="qrcode-host"></div>
</div>

<div class="section">
  <h2>ã‚²ã‚¹ãƒˆå´ QR</h2>
  <div id="qrcode-guest"></div>
</div>

<div class="section">
  <h2>QRèª­ã¿å–ã‚Š</h2>
  <div id="html5-qrcode"></div>
</div>

<div class="section">
  <h2>ãƒ†ã‚­ã‚¹ãƒˆæ¥ç¶šï¼ˆæ‰‹å‹•ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼‰</h2>

  <h3>å—ä¿¡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</h3>
  <textarea id="text-input" placeholder="ã“ã“ã« offer ã¾ãŸã¯ answer ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
  <button id="btn-apply-text">é©ç”¨</button>

  <h3>è‡ªåˆ†ã®ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æƒ…å ±</h3>
  <textarea id="text-output" readonly></textarea>
</div>

<div class="section">
  <h2>ãƒãƒ£ãƒƒãƒˆ</h2>
  <div id="chat-area"></div>
  <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" disabled>
  <button id="chat-send" disabled>é€ä¿¡</button>
</div>

<div class="section">
  <h2>ãƒ­ã‚°</h2>
  <div id="log"></div>
</div>

<script>
/* --- ã“ã“ã‹ã‚‰ JavaScriptï¼ˆQR + ãƒ†ã‚­ã‚¹ãƒˆæ¥ç¶š å®Œå…¨çµ±åˆï¼‰ --- */

const passwordInput = document.getElementById('password');
const roleRadios = document.getElementsByName('role');
const btnHostStart = document.getElementById('btn-host-start');
const btnGuestStart = document.getElementById('btn-guest-start');
const btnStartScan = document.getElementById('btn-start-scan');
const btnStopScan = document.getElementById('btn-stop-scan');
const statusText = document.getElementById('status-text');
const logEl = document.getElementById('log');
const chatArea = document.getElementById('chat-area');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');

const qrcodeHostEl = document.getElementById('qrcode-host');
const qrcodeGuestEl = document.getElementById('qrcode-guest');

const textInput = document.getElementById('text-input');
const textOutput = document.getElementById('text-output');
const btnApplyText = document.getElementById('btn-apply-text');  // â† ä¿®æ­£æ¸ˆã¿

let html5QrCode = null;
let currentRole = 'host';
let pc = null;
let dataChannel = null;

function log(msg) {
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `[${t}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(t) {
  statusText.textContent = t;
}

function getPassword() {
  return passwordInput.value.trim();
}

function checkedRole() {
  for (const r of roleRadios) if (r.checked) return r.value;
  return 'host';
}

function clearQRCodes() {
  qrcodeHostEl.innerHTML = '';
  qrcodeGuestEl.innerHTML = '';
}

function enableChat(b) {
  chatInput.disabled = !b;
  chatSend.disabled = !b;
}

function appendChatMessage(text, self) {
  const div = document.createElement('div');
  div.className = self ? 'chat-self' : 'chat-peer';
  div.textContent = (self ? 'è‡ªåˆ†: ' : 'ç›¸æ‰‹: ') + text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });

  pc.onconnectionstatechange = () => {
    log(`connectionState: ${pc.connectionState}`);
    if (pc.connectionState === 'connected') {
      setStatus('æ¥ç¶šå®Œäº†');
      enableChat(true);
    }
  };

  pc.ondatachannel = (ev) => {
    setupDataChannel(ev.channel);
  };

  log('RTCPeerConnection ä½œæˆ');
}

function setupDataChannel(ch) {
  dataChannel = ch;
  dataChannel.onopen = () => {
    log('ãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒãƒ« open');
    enableChat(true);
  };
  dataChannel.onmessage = (ev) => {
    appendChatMessage(ev.data, false);
  };
}

function createQrPayload(type, sdp, password) {
  return JSON.stringify({
    v: 1,
    role: currentRole,
    kind: type,
    pass: password,
    sdp: sdp
  });
}

async function handleQrPayload(text) {
  log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿: ' + text.slice(0, 40) + '...');

  let obj;
  try { obj = JSON.parse(text); }
  catch { alert("JSON å½¢å¼ãŒä¸æ­£ã§ã™"); return; }

  const password = getPassword();
  if (!password) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if (obj.pass !== password) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“"); return; }

  if (!pc) createPeerConnection();

  if (obj.kind === "offer") {
    await pc.setRemoteDescription({ type: "offer", sdp: obj.sdp });
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    const payload = createQrPayload("answer", answer.sdp, password);
    textOutput.value = payload;

    qrcodeGuestEl.innerHTML = "";
    new QRCode(qrcodeGuestEl, { text: payload, width: 200, height: 200 });

    setStatus("ã‚²ã‚¹ãƒˆ: answer ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
    log("answer ç”Ÿæˆ");

  } else if (obj.kind === "answer") {
    await pc.setRemoteDescription({ type: "answer", sdp: obj.sdp });
    setStatus("ãƒ›ã‚¹ãƒˆ: answer ã‚’å—ä¿¡ã—ã¾ã—ãŸ");
    log("answer é©ç”¨");
  }
}

/* --- ãƒœã‚¿ãƒ³å‡¦ç† --- */

btnHostStart.onclick = async () => {
  currentRole = "host";
  const password = getPassword();
  if (!password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  clearQRCodes();
  enableChat(false);

  createPeerConnection();
  const ch = pc.createDataChannel("chat");
  setupDataChannel(ch);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const payload = createQrPayload("offer", offer.sdp, password);
  textOutput.value = payload;

  new QRCode(qrcodeHostEl, { text: payload, width: 200, height: 200 });

  setStatus("ãƒ›ã‚¹ãƒˆ: offer ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
  log("offer ç”Ÿæˆ");

  btnStartScan.disabled = false;
};

btnGuestStart.onclick = () => {
  currentRole = "guest";
  const password = getPassword();
  if (!password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  clearQRCodes();
  enableChat(false);

  createPeerConnection();
  setStatus("ã‚²ã‚¹ãƒˆ: ãƒ›ã‚¹ãƒˆã® offer ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");

  btnStartScan.disabled = false;
};

btnStartScan.onclick = () => {
  if (!html5QrCode) html5QrCode = new Html5Qrcode("html5-qrcode");

  Html5Qrcode.getCameras().then(cams => {
    if (!cams.length) return alert("ã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“");

    html5QrCode.start(
      cams[0].id,
      { fps: 10, qrbox: 220 },
      (decoded) => {
        html5QrCode.stop();
        btnStartScan.disabled = false;
        btnStopScan.disabled = true;
        handleQrPayload(decoded);
      }
    );

    btnStartScan.disabled = true;
    btnStopScan.disabled = false;
    log("QRèª­ã¿å–ã‚Šé–‹å§‹");
  });
};

btnStopScan.onclick = () => {
  if (html5QrCode) {
    html5QrCode.stop();
    btnStartScan.disabled = false;
    btnStopScan.disabled = true;
  }
};

btnApplyText.onclick = () => {
  const text = textInput.value.trim();
  if (!text) return alert("ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™");
  handleQrPayload(text);
};

chatSend.onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  dataChannel.send(text);
  appendChatMessage(text, true);
  chatInput.value = "";
};

chatInput.onkeydown = (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    chatSend.click();
  }
};

for (const r of roleRadios) {
  r.onchange = () => currentRole = checkedRole();
}

</script>
</body>
</html>

