<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>救急用 現在位置表示</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { font-size: 2rem; padding: 16px 32px; margin: 10px 0; }
    #result { margin-top: 20px; font-size: 1.6rem; line-height: 2; }
    #status { color: red; font-size: 1.2rem; }
    .label { font-weight: bold; }
  </style>
</head>
<body>
  <h1>救急用 現在位置表示</h1>
  <button onclick="getLocation()">現在位置を取得</button>

  <div id="result">
    <div><span class="label">緯度:</span> <span id="lat">-</span></div>
    <div><span class="label">経度:</span> <span id="lng">-</span></div>
    <div><span class="label">住所:</span> <span id="address">-</span></div>
    <div id="status"></div>
  </div>

  <script>
    async function getLocation() {
      const status = document.getElementById('status');
      const latSpan = document.getElementById('lat');
      const lngSpan = document.getElementById('lng');
      const addrSpan = document.getElementById('address');

      status.textContent = '現在位置取得中…';
      addrSpan.textContent = '-';

      if (!navigator.geolocation) {
        status.textContent = 'この端末では位置情報が利用できません。';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          latSpan.textContent = lat.toFixed(6);
          lngSpan.textContent = lng.toFixed(6);

          try {
            // Base64で難読化されたAPIキー（例：'abcd1234...' → 'YWJjZDEyMzQ='）
            const encodedKey = 'T1BDR0VfQVBJX0tFWV9IRVJF'; // ← 自分のAPIキーをBase64で変換して入れてね
            const apiKey = atob(encodedKey);

            const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}&language=ja&pretty=1`;
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            const data = await res.json();

            const result = data.results[0];
            const address = result.formatted || '住所を特定できませんでした';
            addrSpan.textContent = address;
            status.textContent = '';
          } catch (e) {
            addrSpan.textContent = '住所取得エラー';
            status.textContent = '住所の取得に失敗しました。';
          }
        },
        (err) => {
          status.textContent = '位置情報の取得に失敗しました。';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
  </script>
</body>
</html>
