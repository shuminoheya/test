<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ファイル暗号化・復号化</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #f0f4f8, #e0ecf4);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 400px;
      text-align: center;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #333;
    }
    label {
      margin: 0 10px;
      font-weight: bold;
      color: #444;
    }
    input[type="file"],
    input[type="password"] {
      margin: 10px 0;
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 20px;
      appearance: none;
    }
    progress::-webkit-progress-bar {
      background-color: #eee;
      border-radius: 10px;
    }
    progress::-webkit-progress-value {
      background-color: #4CAF50;
      border-radius: 10px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.95em;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ファイル暗号化・復号化</h1>
    <p>このページはファイルを趣味の部屋独自のフォーマットで暗号化してそのファイルを復号化できるサイトです。</p>
    <label><input type="radio" name="mode" value="encrypt" checked> 暗号化</label>
    <label><input type="radio" name="mode" value="decrypt"> 復号化</label><br><br>
    <input type="file" id="fileInput"><br>
    <input type="password" id="password" placeholder="パスワードを入力"><br>
    <label><input type="checkbox" id="lowMemory"> パフォーマンス低下モード（低メモリ）</label><br><br>
    <button id="run">実行</button>
    <progress id="bar" value="0" max="100"></progress>
    <p id="status">待機中</p>
  </div>
  <script>
    const CHUNK = 15 * 1024 * 1024;
    function removeExt(name) {
      return name.endsWith('.shumi') ? name.slice(0, -6) : name;
    }
    async function deriveKey(pw) {
      const e = new TextEncoder();
      const s = e.encode('shumi-salt');
      const m = await crypto.subtle.importKey('raw', e.encode(pw), { name: 'PBKDF2' }, false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name: 'PBKDF2', salt: s, iterations: 100000, hash: 'SHA-256' }, m, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
    }
    document.getElementById('run').addEventListener('click', async () => {
      const f = document.getElementById('fileInput').files[0];
      const pw = document.getElementById('password').value;
      const m = document.querySelector('input[name="mode"]:checked').value;
      const low = document.getElementById('lowMemory').checked;
      const s = document.getElementById('status');
      const b = document.getElementById('bar');
      if (!f || !pw) return alert('ファイルとパスワードを入力');
      const k = await deriveKey(pw);
      let ws = null;
      let out = [];
      if (low && window.showSaveFilePicker) {
        try {
          const name = m === 'encrypt' ? f.name + '.shumi' : removeExt(f.name);
          const h = await window.showSaveFilePicker({ suggestedName: name });
          ws = await h.createWritable();
        } catch {
          s.textContent = '保存キャンセル、メモリに切替';
        }
      }
      b.value = 0;
      b.max = f.size;
      try {
        if (m === 'encrypt') {
          const total = Math.ceil(f.size / CHUNK);
          let off = 0, i = 0;
          while (off < f.size) {
            const chunk = await f.slice(off, off + CHUNK).arrayBuffer();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const enc = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, k, chunk);
            const len = new Uint8Array(4);
            new DataView(len.buffer).setUint32(0, enc.byteLength, true);
            const comb = new Uint8Array(4 + 12 + enc.byteLength);
            comb.set(len, 0);
            comb.set(iv, 4);
            comb.set(new Uint8Array(enc), 16);
            if (ws) await ws.write(comb); else out.push(comb);
            off += CHUNK;
            i++;
            b.value = off;
            s.textContent = `暗号化中 ${i}/${total}`;
            await new Promise(requestAnimationFrame);
          }
        } else {
          const buf = await f.arrayBuffer();
          const dv = new DataView(buf);
          let off = 0, total = 0;
          while (off + 16 <= buf.byteLength) {
            const len = dv.getUint32(off, true);
            off += 16 + len;
            total++;
          }
          off = 0;
          let i = 0;
          while (off + 16 <= buf.byteLength) {
            const len = dv.getUint32(off, true);
            const iv = new Uint8Array(buf.slice(off + 4, off + 16));
            const dat = buf.slice(off + 16, off + 16 + len);
            const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, k, dat);
            if (ws) await ws.write(new Uint8Array(dec)); else out.push(new Uint8Array(dec));
            off += 16 + len;
            i++;
            b.value = off;
            s.textContent = `復号中 ${i}/${total}`;
            await new Promise(requestAnimationFrame);
          }
        }
        if (ws) {
          await ws.close();
          s.textContent = '完了（保存）';
        } else {
          const blob = new Blob(out);
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = m === 'encrypt' ? f.name + '.shumi' : removeExt(f.name);
          a.click();
          s.textContent = '完了（ダウンロード）';
        }
        b.value = b.max;
      } catch (e) {
        s.textContent = 'エラー: ' + e.message;
      }
    });
  </script>
</body>
</html>
